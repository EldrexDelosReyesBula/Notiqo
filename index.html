<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Social</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="app-section">
        <!-- Auth Modal -->
        <div id="authModal" class="auth-modal">
            <div class="auth-container">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
                    <div class="auth-tab" onclick="switchAuthTab('register')">Sign Up</div>
                </div>

                <form id="loginForm" class="auth-form" onsubmit="loginUser(event)">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button type="submit">Sign In</button>
                    <div class="auth-footer">
                        <a onclick="switchAuthTab('register')">Don't have an account? Sign Up</a>
                        <a onclick="showForgotPassword()">Forgot password?</a>
                    </div>
                </form>

                <form id="registerForm" class="auth-form" style="display: none;" onsubmit="registerUser(event)">
                    <input type="text" id="registerName" placeholder="Full Name" required>
                    <input type="email" id="registerEmail" placeholder="Email" required>
                    <input type="password" id="registerPassword" placeholder="Password" required>
                    <button type="submit">Sign Up</button>
                    <div class="auth-footer">
                        <a onclick="switchAuthTab('login')">Already have an account? Sign In</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div id="forgotPasswordModal" class="auth-modal">
            <div class="auth-container">
                <div class="auth-tabs">
                    <div class="auth-tab active">Reset Password</div>
                </div>
                <form id="forgotPasswordForm" class="auth-form" onsubmit="resetPassword(event)">
                    <input type="email" id="resetEmail" placeholder="Email" required>
                    <button type="submit">Send Reset Link</button>
                    <div class="auth-footer">
                        <a onclick="hideForgotPassword()">Back to Sign In</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2>Menu</h2>
                <i class="fas fa-times" onclick="toggleSidebar()"></i>
            </div>
            <ul class="sidebar-menu">
                <li onclick="showSection('home')"><i class="fas fa-home"></i> Home</li>
                <li onclick="showSection('explore')"><i class="fas fa-compass"></i> Explore</li>
                <li onclick="showSection('notifications')"><i class="fas fa-bell"></i> Notifications</li>
                <li onclick="showSection('find-users')"><i class="fas fa-users"></i> Find Users</li>
                <li onclick="showSection('profile')"><i class="fas fa-user"></i> Profile</li>
                <li onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</li>
                <li onclick="signOut()"><i class="fas fa-sign-out-alt"></i> Sign Out</li>
            </ul>
        </aside>

        <!-- Header -->
        <header id="header">
            <div class="logo">Connect</div>
            <div class="nav-icons">
                <i class="fas fa-search" onclick="showSection('explore')"></i>
                <i class="fas fa-bell" onclick="showSection('notifications')">
                    <span class="badge" id="notificationBadge">0</span>
                </i>
                <i class="fas fa-bars nav-icon" onclick="toggleSidebar()"></i>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Home section -->
            <section id="home" class="active-section">
                <div id="publishedContent">
                    <!-- Posts will be dynamically added here -->
                    <div class="skeleton skeleton-post"></div>
                    <div class="skeleton skeleton-post"></div>
                </div>
            </section>

            <!-- Explore section -->
            <section id="explore">
                <div class="section-header">
                    <i class="fas fa-chevron-left section-back" onclick="showSection('home')"></i>
                    <h2 class="section-title">Explore</h2>
                    <div></div> <!-- Empty div for flex spacing -->
                </div>

                <div id="search-area" class="search-area">
                    <input type="text" id="searchQuery" placeholder="Search users or content..." oninput="handleSearchInput()" style="width: 80%;">
                    <button onclick="searchContent()"><i class="fas fa-search"></i></button>
                </div>

                <div id="searchResults" class="search-results" style="width: 100; overflow: hidden;">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>Search for users or content</h3>
                        <p>Enter a name, username, or topic to find what you're looking for</p>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;">Suggested Users</h3>
                <div id="suggestedUsers" class="user-list">
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                </div>
            </section>

            <!-- Notifications section -->
            <section id="notifications">
                <div class="section-header">
                    <i class="fas fa-chevron-left section-back" onclick="showSection('home')"></i>
                    <h2 class="section-title">Notifications</h2>
                    <i class="fas fa-ellipsis-v" onclick="showNotificationSettings()"></i>
                </div>

                <div id="notificationsList">
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                </div>
            </section>

            <!-- Find Users section -->
            <section id="find-users">
                <div class="section-header">
                    <i class="fas fa-chevron-left section-back" onclick="showSection('home')"></i>
                    <h2 class="section-title">Find Users</h2>
                    <div></div> <!-- Empty div for flex spacing -->
                </div>

                <div class="profile-actions">
                    <button class="follow-btn" onclick="showFindTab('find')">Find Users</button>
                    <button class="follow-btn" onclick="showFindTab('followers')">Followers</button>
                    <button class="follow-btn" onclick="showFindTab('following')">Following</button>
                </div>

                <div id="findUsersTab" class="user-list">
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                </div>

                <div id="followersTab" class="user-list" style="display: none;">
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                </div>

                <div id="followingTab" class="user-list" style="display: none;">
                    <div class="skeleton skeleton-user"></div>
                    <div class="skeleton skeleton-user"></div>
                </div>
            </section>

            <!-- Profile section -->
            <section id="profile">
                <div id="profile-info">
                    <div class="section-header">
                        <i class="fas fa-chevron-left section-back" onclick="showSection('home')"></i>
                        <h2 class="section-title">Profile</h2>
                        <i class="fas fa-ellipsis-v" onclick="showProfileMenu()"></i>
                    </div>

                    <div class="profile-header">
                        <div class="profile-picture-container">
                            <div class="user-avatar profile" id="profileInitial">U</div>
                        </div>
                        <div class="user-details">
                            <h2 id="profileName">User Name</h2>
                            <div class="user-bio" id="profileBio">This is a bio. Max 110 characters.</div>

                            <div class="profile-stats">
                                <div class="profile-stat" onclick="showFindTab('followers')">
                                    <span id="profileFollowersCount">0</span> followers
                                </div>
                                <div class="profile-stat" onclick="showFindTab('following')">
                                    <span id="profileFollowingCount">0</span> following
                                </div>
                            </div>

                            <div class="profile-actions">
                                <button class="follow-btn" id="followButton" disabled>Follow</button>
                                <button class="follow-btn" onclick="shareProfile()">
                                    <i class="fas fa-share"></i> Share
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="profilePosts" class="content-container">
                        <div class="empty-state">
                            <i class="fas fa-edit"></i>
                            <h3>No posts yet</h3>
                            <p>Create your first post to share with others</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings section -->
            <section id="settings" class="settings-container">
                <div class="section-header">
                    <i class="fas fa-chevron-left section-back" onclick="showSection('home')"></i>
                    <h2 class="section-title">Settings</h2>
                    <div></div> <!-- Empty div for flex spacing -->
                </div>

                <form id="settingsForm" class="settings-form">
                    <div class="settings-section">
                        <h2 class="settings-subtitle"><i class="fas fa-user"></i> Profile Settings</h2>
                        <label for="settingsName">Name:</label>
                        <input type="text" id="settingsName" placeholder="Your name">

                        <label for="settingsBio">Bio:</label>
                        <textarea id="settingsBio" placeholder="Tell others about yourself (max 110 chars)" maxlength="110"></textarea>
                    </div>

                    <div class="settings-section">
                        <h2 class="settings-subtitle"><i class="fas fa-paint-brush"></i> Appearance</h2>
                        <label class="toggle-label">
                            <span class="toggle-text">Dark Mode</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                    </div>

                    <div class="settings-section">
                        <h2 class="settings-subtitle"><i class="fas fa-bell"></i> Notifications</h2>
                        <label class="toggle-label">
                            <span class="toggle-text">New Followers</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notifFollowersToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </label>

                        <label class="toggle-label">
                            <span class="toggle-text">Likes & Comments</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notifLikesToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </label>

                        <label class="toggle-label">
                            <span class="toggle-text">Mentions</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notifMentionsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                    </div>

                    <div class="settings-section">
                        <h2 class="settings-subtitle"><i class="fas fa-file-alt"></i> Legal</h2>
                        <button type="button" class="follow-btn" onclick="showLegalDocument('privacy')">Privacy Policy</button>
                        <button type="button" class="follow-btn" onclick="showLegalDocument('terms')">Terms of Use</button>
                    </div>

                    <div class="settings-section">
                        <h2 class="settings-subtitle"><i class="fas fa-shield-alt"></i> Account</h2>
                        <button type="button" class="follow-btn" onclick="signOut()">Sign Out</button>
                        <button type="button" class="follow-btn" style="background-color: var(--warning-color);" onclick="requestAccountDeletion()">Delete Account</button>
                    </div>
                </form>
            </section>

            <!-- Stalked User Profile -->
            <section id="stalked-profile" style="display: none;">
                <div id="stalkedProfileContent"></div>
            </section>
        </main>

        <!-- Post form modal -->
        <div id="postFormContainer" class="post-form-container">
            <div class="post-form">
                <div class="post-form-header">
                    <h2 class="post-form-title">Create Post</h2>
                    <i class="fas fa-times post-form-close" onclick="togglePostFormContainer()"></i>
                </div>
                <form id="postForm" onsubmit="createPost(event)">
                    <div class="color-options">
                        <div class="color-option selected" data-color="default" onclick="selectPostColor(this)" title="Default"></div>
                        <div class="color-option" data-color="blue" onclick="selectPostColor(this)" title="Blue"></div>
                        <div class="color-option" data-color="green" onclick="selectPostColor(this)" title="Green"></div>
                        <div class="color-option" data-color="purple" onclick="selectPostColor(this)" title="Purple"></div>
                        <div class="color-option" data-color="red" onclick="selectPostColor(this)" title="Red"></div>
                        <div class="color-option" data-color="orange" onclick="selectPostColor(this)" title="Orange"></div>
                    </div>

                    <input type="text" id="postTitle" placeholder="Title (optional)">
                    <textarea id="postDescription" placeholder="What's on your mind?" required></textarea>
                    <input type="text" id="postAuthor" placeholder="Source/Author (optional)">
                    <button type="submit">Publish</button>
                </form>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <i class="fas fa-home" onclick="showSection('home')"></i>
            <i class="fas fa-compass" onclick="showSection('explore')"></i>
            <i id="toggle-button" class="fas fa-plus-circle" onclick="togglePostFormContainer()"></i>
            <i class="fas fa-bell" onclick="showSection('notifications')"></i>
            <i class="fas fa-user" onclick="showSection('profile')"></i>
        </div>

        <!-- Legal Document Modal -->
        <div id="legalModal" class="auth-modal">
            <div class="auth-container" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="auth-tabs">
                    <div class="auth-tab active" id="legalDocTitle">Document</div>
                    <i class="fas fa-times" onclick="hideLegalDocument()" style="cursor: pointer;"></i>
                </div>
                <div id="legalDocContent" style="padding: 1rem; line-height: 1.6;">
                    Loading document...
                </div>
            </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="post-menu-options" style="position: fixed; top: 60px; right: 20px; display: none;">
            <button onclick="editProfile()"><i class="fas fa-edit"></i> Edit Profile</button>
            <button onclick="shareProfile()"><i class="fas fa-share"></i> Share Profile</button>
            <button onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</button>
        </div>

        <!-- Notification Settings Menu -->
        <div id="notificationSettingsMenu" class="post-menu-options" style="position: fixed; top: 60px; right: 20px; display: none;">
            <button onclick="markAllAsRead()"><i class="fas fa-check"></i> Mark All as Read</button>
            <button onclick="showSection('settings')"><i class="fas fa-cog"></i> Notification Settings</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfQEnaR6NICnZIr7c5smbucSoGeiXcV5k",
            authDomain: "lantalk-pro.firebaseapp.com",
            databaseURL: "https://lantalk-pro-default-rtdb.firebaseio.com",
            projectId: "lantalk-pro",
            storageBucket: "lantalk-pro.firebasestorage.app",
            messagingSenderId: "1036484461310",
            appId: "1:1036484461310:web:7d1b4be7b207bbafe69baf",
            measurementId: "G-WPZNYDZVPE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const realtimeDb = firebase.database();

        // DOM Elements
        const authModal = document.getElementById('authModal');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const sidebar = document.getElementById('sidebar');
        const postFormContainer = document.getElementById('postFormContainer');
        const publishedContent = document.getElementById('publishedContent');
        const profileInitial = document.getElementById('profileInitial');
        const profileName = document.getElementById('profileName');
        const profileBio = document.getElementById('profileBio');
        const followButton = document.getElementById('followButton');

        // Current user data
        let currentUser = null;
        let currentUserData = null;
        let posts = [];
        let selectedPostColor = 'default';
        let viewingProfileUserId = null;
        let notificationCount = 0;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    showSection('home');
                    authModal.classList.remove('show');
                    loadPosts();
                    loadNotifications();
                    loadSuggestedUsers();
                } else {
                    authModal.classList.add('show');
                    currentUser = null;
                }
            });

            // Check for dark mode preference
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }
        });

        // UI Functions
        function toggleSidebar() {
            sidebar.classList.toggle('show');
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('section').forEach(section => {
                section.classList.remove('active-section');
            });

            // Show the selected section
            document.getElementById(sectionId).classList.add('active-section');

            // Close sidebar if open
            sidebar.classList.remove('show');

            // Close post form if open
            postFormContainer.classList.remove('show');

            // Close menus if open
            document.getElementById('profileMenu').classList.remove('show');
            document.getElementById('notificationSettingsMenu').classList.remove('show');

            // Load data if needed
            if (sectionId === 'notifications') {
                loadNotifications();
            } else if (sectionId === 'find-users') {
                showFindTab('find');
            } else if (sectionId === 'profile') {
                if (!viewingProfileUserId) {
                    viewingProfileUserId = currentUser.uid;
                }
                loadProfilePosts();
            }
        }

        function togglePostFormContainer() {
            if (!currentUser) {
                alert('Please sign in to create a post');
                return;
            }

            postFormContainer.classList.toggle('show');
            
            if (!postFormContainer.classList.contains('show')) {
                // Reset form when closing
                document.getElementById('postForm').reset();
                selectedPostColor = 'default';
                document.querySelector('.color-option[data-color="default"]').classList.add('selected');
            }
        }

        function selectPostColor(element) {
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedPostColor = element.getAttribute('data-color');
        }

        // Auth functions
        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.querySelector('.auth-tab.active').classList.remove('active');
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                loginForm.style.display = 'flex';
                registerForm.style.display = 'none';
            } else {
                document.querySelector('.auth-tab.active').classList.remove('active');
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'flex';
            }
        }

        function showForgotPassword() {
            authModal.classList.remove('show');
            forgotPasswordModal.classList.add('show');
        }

        function hideForgotPassword() {
            forgotPasswordModal.classList.remove('show');
            authModal.classList.add('show');
            switchAuthTab('login');
        }

        function loginUser(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const loginBtn = e.target.querySelector('button');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<div class="loading"></div>';

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    loginBtn.innerHTML = originalText;
                })
                .catch(error => {
                    loginBtn.innerHTML = originalText;
                    alert(error.message);
                });
        }

        function resetPassword(e) {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;

            const resetBtn = e.target.querySelector('button');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<div class="loading"></div>';

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    resetBtn.innerHTML = originalText;
                    alert('Password reset email sent! Check your inbox.');
                    hideForgotPassword();
                })
                .catch(error => {
                    resetBtn.innerHTML = originalText;
                    alert(error.message);
                });
        }

        function registerUser(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            // Auto-generate username
            const username = `${name.replace(/\s+/g, '').toLowerCase()}@landecs.org_${Math.random().toString(36).substr(2, 8)}`;

            const registerBtn = e.target.querySelector('button');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = '<div class="loading"></div>';

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save additional user data to Firestore
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name,
                        username,
                        email,
                        bio: "",
                        joined: firebase.firestore.FieldValue.serverTimestamp(),
                        followers: [],
                        following: [],
                        notificationsEnabled: {
                            followers: true,
                            likes: true,
                            mentions: true
                        }
                    });
                })
                .then(() => {
                    registerBtn.innerHTML = originalText;
                })
                .catch(error => {
                    registerBtn.innerHTML = originalText;
                    alert(error.message);
                });
        }

        function signOut() {
            auth.signOut().then(() => {
                currentUser = null;
                authModal.classList.add('show');
                window.location.reload(); // Refresh to clear all data
            });
        }

        // User data functions
        function loadUserData(uid) {
            db.collection('users').doc(uid).get()
                .then(doc => {
                    if (doc.exists) {
                        currentUserData = doc.data();
                        updateProfileUI(currentUserData);

                        // Load the profile we're viewing (default to current user)
                        if (!viewingProfileUserId) {
                            viewingProfileUserId = uid;
                            loadProfilePosts();
                        }

                        // Update notification settings toggles
                        if (currentUserData.notificationsEnabled) {
                            document.getElementById('notifFollowersToggle').checked = currentUserData.notificationsEnabled.followers;
                            document.getElementById('notifLikesToggle').checked = currentUserData.notificationsEnabled.likes;
                            document.getElementById('notifMentionsToggle').checked = currentUserData.notificationsEnabled.mentions;
                        }
                    }
                });
        }

        function updateProfileUI(userData) {
            profileName.textContent = userData.name;
            profileBio.textContent = userData.bio || "No bio yet";
            document.getElementById('profileFollowersCount').textContent = userData.followers ? userData.followers.length : 0;
            document.getElementById('profileFollowingCount').textContent = userData.following ? userData.following.length : 0;

            // Update settings form
            if (document.getElementById('settingsName')) {
                document.getElementById('settingsName').value = userData.name;
                document.getElementById('settingsBio').value = userData.bio || "";
            }

            // Update profile initial
            profileInitial.textContent = userData.name.charAt(0).toUpperCase();

            // Update follow button if viewing another profile
            if (viewingProfileUserId && viewingProfileUserId !== currentUser.uid) {
                updateFollowButton(userData);
            } else {
                followButton.style.display = 'none';
            }
        }

        function updateFollowButton(userData) {
            if (!currentUser || !viewingProfileUserId) return;

            followButton.style.display = 'block';
            followButton.disabled = false;

            if (userData.followers && userData.followers.includes(currentUser.uid)) {
                followButton.textContent = 'Following';
                followButton.classList.add('following');
            } else {
                followButton.textContent = 'Follow';
                followButton.classList.remove('following');
            }
        }

        function toggleFollow() {
            if (!currentUser || !viewingProfileUserId || viewingProfileUserId === currentUser.uid) return;

            const isFollowing = followButton.textContent === 'Following';

            if (isFollowing) {
                // Unfollow logic
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayRemove(viewingProfileUserId)
                });

                db.collection('users').doc(viewingProfileUserId).update({
                    followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                }).then(() => {
                    followButton.textContent = 'Follow';
                    followButton.classList.remove('following');
                    updateFollowerCount();

                    // Update current user data
                    if (currentUserData.following) {
                        currentUserData.following = currentUserData.following.filter(id => id !== viewingProfileUserId);
                    }
                });
            } else {
                // Follow logic
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayUnion(viewingProfileUserId)
                });

                db.collection('users').doc(viewingProfileUserId).update({
                    followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                }).then(() => {
                    followButton.textContent = 'Following';
                    followButton.classList.add('following');
                    updateFollowerCount();

                    // Update current user data
                    if (!currentUserData.following) {
                        currentUserData.following = [];
                    }
                    currentUserData.following.push(viewingProfileUserId);

                    // Send notification if enabled
                    sendNotification(viewingProfileUserId, 'follow', currentUser.uid);
                });
            }
        }

        function sendNotification(userId, type, senderId, postId = null) {
            if (!userId || !type || !senderId) return;

            // Check if user has notifications enabled for this type
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const notificationsEnabled = userData.notificationsEnabled || {
                            followers: true,
                            likes: true,
                            mentions: true
                        };

                        let shouldSend = false;
                        let message = "";

                        switch (type) {
                            case 'follow':
                                shouldSend = notificationsEnabled.followers;
                                message = "started following you";
                                break;
                            case 'like':
                                shouldSend = notificationsEnabled.likes;
                                message = "liked your post";
                                break;
                            case 'mention':
                                shouldSend = notificationsEnabled.mentions;
                                message = "mentioned you in a post";
                                break;
                        }

                        if (shouldSend) {
                            const notification = {
                                type,
                                senderId,
                                message,
                                read: false,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };

                            if (postId) {
                                notification.postId = postId;
                            }

                            // Add notification to user's collection
                            db.collection('notifications').doc(userId).collection('userNotifications').add(notification)
                                .then(() => {
                                    // Update notification count
                                    if (userId === currentUser.uid) {
                                        notificationCount++;
                                        updateNotificationBadge();
                                    }
                                });
                        }
                    }
                });
        }

        function updateFollowerCount() {
            if (viewingProfileUserId) {
                db.collection('users').doc(viewingProfileUserId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            document.getElementById('profileFollowersCount').textContent = userData.followers ? userData.followers.length : 0;
                        }
                    });
            }
        }

        function loadSuggestedUsers() {
            if (!currentUser) return;

            // In a real app, this would use an algorithm to suggest users
            // For demo, we'll just get random users (excluding current user and already followed)
            db.collection('users')
                .where('username', '!=', currentUserData.username)
                .limit(5)
                .get()
                .then(querySnapshot => {
                    const suggestedUsersContainer = document.getElementById('suggestedUsers');
                    suggestedUsersContainer.innerHTML = '';

                    if (querySnapshot.empty) {
                        suggestedUsersContainer.innerHTML = '<div class="empty-state">No suggested users found</div>';
                        return;
                    }

                    querySnapshot.forEach(doc => {
                        const user = doc.data();
                        const isFollowing = currentUserData.following && currentUserData.following.includes(doc.id);

                        const userElement = document.createElement('div');
                        userElement.className = 'user-item';
                        userElement.innerHTML = `
                            <div class="user-item-info" onclick="viewUserProfile('${doc.id}')">
                                <div class="user-item-avatar">${user.name.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div class="user-item-name">${user.name}</div>
                                    <div class="user-item-username">@${user.username}</div>
                                </div>
                            </div>
                            <button class="follow-btn ${isFollowing ? 'following' : ''}" 
                                onclick="toggleSuggestedFollow('${doc.id}', this)">
                                ${isFollowing ? 'Following' : 'Follow'}
                            </button>
                        `;

                        suggestedUsersContainer.appendChild(userElement);
                    });
                });
        }

        function toggleSuggestedFollow(userId, button) {
            if (!currentUser) return;

            const isFollowing = button.textContent === 'Following';

            if (isFollowing) {
                // Unfollow
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayRemove(userId)
                });

                db.collection('users').doc(userId).update({
                    followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                }).then(() => {
                    button.textContent = 'Follow';
                    button.classList.remove('following');

                    // Update current user data
                    if (currentUserData.following) {
                        currentUserData.following = currentUserData.following.filter(id => id !== userId);
                    }
                });
            } else {
                // Follow
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayUnion(userId)
                });

                db.collection('users').doc(userId).update({
                    followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                }).then(() => {
                    button.textContent = 'Following';
                    button.classList.add('following');

                    // Update current user data
                    if (!currentUserData.following) {
                        currentUserData.following = [];
                    }
                    currentUserData.following.push(userId);

                    // Send notification
                    sendNotification(userId, 'follow', currentUser.uid);
                });
            }
        }

        // Post functions
        function createPost(e) {
            e.preventDefault();

            const title = document.getElementById('postTitle').value;
            const description = document.getElementById('postDescription').value;
            const author = document.getElementById('postAuthor').value;

            const postBtn = e.target.querySelector('button');
            const originalText = postBtn.innerHTML;
            postBtn.innerHTML = '<div class="loading"></div>';

            // Create post in Firestore
            const postData = {
                title,
                description,
                author,
                userId: currentUser.uid,
                userName: currentUserData.name,
                userUsername: currentUserData.username,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                likes: [],
                comments: [],
                shares: 0
            };

            if (selectedPostColor !== 'default') {
                postData.bgColor = selectedPostColor;
            }

            db.collection('posts').add(postData)
                .then(() => {
                    postBtn.innerHTML = originalText;
                    togglePostFormContainer();
                    loadPosts();
                    loadProfilePosts();
                })
                .catch(error => {
                    postBtn.innerHTML = originalText;
                    alert('Error creating post: ' + error.message);
                });
        }

        function loadPosts() {
            if (!currentUser) return;

            // Show loading skeletons
            publishedContent.innerHTML = `
                <div class="skeleton skeleton-post"></div>
                <div class="skeleton skeleton-post"></div>
            `;

            // Get posts from people the user follows and their own posts
            let query = db.collection('posts')
                .orderBy('createdAt', 'desc')
                .limit(20);

            // If user follows people, get their posts too
            if (currentUserData.following && currentUserData.following.length > 0) {
                query = db.collection('posts')
                    .where('userId', 'in', [...currentUserData.following, currentUser.uid])
                    .orderBy('createdAt', 'desc')
                    .limit(20);
            }

            query.get()
                .then(querySnapshot => {
                    publishedContent.innerHTML = '';
                    posts = [];

                    if (querySnapshot.empty) {
                        publishedContent.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-edit"></i>
                                <h3>No posts yet</h3>
                                <p>Follow some users or create your first post</p>
                            </div>
                        `;
                        return;
                    }

                    querySnapshot.forEach(doc => {
                        const post = doc.data();
                        post.id = doc.id;
                        posts.push(post);
                        renderPost(post, publishedContent);
                    });
                });
        }

        function loadProfilePosts() {
            if (!currentUser || !viewingProfileUserId) return;

            const profilePostsContainer = document.getElementById('profilePosts');

            // Show loading skeletons
            profilePostsContainer.innerHTML = `
                <div class="skeleton skeleton-post"></div>
                <div class="skeleton skeleton-post"></div>
            `;

            db.collection('posts')
                .where('userId', '==', viewingProfileUserId)
                .orderBy('createdAt', 'desc')
                .get()
                .then(querySnapshot => {
                    profilePostsContainer.innerHTML = '';

                    if (querySnapshot.empty) {
                        profilePostsContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-edit"></i>
                                <h3>No posts yet</h3>
                                <p>Create your first post to share with others</p>
                            </div>
                        `;
                        return;
                    }

                    querySnapshot.forEach(doc => {
                        const post = doc.data();
                        post.id = doc.id;
                        renderPost(post, profilePostsContainer);
                    });
                });
        }

        function renderPost(post, container) {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            if (post.bgColor) {
                postElement.setAttribute('data-bg-color', post.bgColor);
            }

            // Format date
            const date = post.createdAt.toDate();
            const formattedDate = date.toLocaleString('default', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Check if description is long
            const isLongDescription = post.description.length > 200;
            const displayDescription = isLongDescription ?
                post.description.substring(0, 200) + '...' :
                post.description;

            postElement.innerHTML = `
                <div class="post-header">
                    <div class="post-user" onclick="viewUserProfile('${post.userId}')">
                        <div class="user-avatar">${post.userName.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="user-name">${post.userName}</div>
                            <small>${formattedDate}</small>
                        </div>
                    </div>
                    ${post.userId === currentUser?.uid ? `
                    <div class="post-actions">
                        <i class="fas fa-ellipsis-v post-menu" onclick="togglePostMenu(this)"></i>
                        <div class="post-menu-options">
                            <button onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="post-content">
                    ${post.title ? `<h3>${post.title}</h3>` : ''}
                    <div class="post-description ${isLongDescription ? 'collapsed' : ''}">
                        ${displayDescription.replace(/\n/g, '<br>')}
                    </div>
                    ${post.author ? `<div class="post-author"><small>Source: ${post.author}</small></div>` : ''}
                    ${isLongDescription ? `<div class="read-more" onclick="expandPostDescription(this)">Read more</div>` : ''}
                </div>
                <div class="post-footer">
                    <div class="post-stats">
                        <div class="post-stat" onclick="likePost('${post.id}')">
                            <i class="fas fa-heart ${post.likes?.includes(currentUser?.uid) ? 'liked' : ''}"></i>
                            <span>${post.likes?.length || 0}</span>
                        </div>
                        <div class="post-stat">
                            <i class="fas fa-comment"></i>
                            <span>${post.comments?.length || 0}</span>
                        </div>
                        <div class="post-stat" onclick="sharePost('${post.id}')">
                            <i class="fas fa-share"></i>
                            <span>${post.shares || 0}</span>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(postElement);
        }

        function togglePostMenu(icon) {
            const menu = icon.nextElementSibling;
            menu.classList.toggle('show');

            // Close other open menus
            document.querySelectorAll('.post-menu-options').forEach(otherMenu => {
                if (otherMenu !== menu && otherMenu.classList.contains('show')) {
                    otherMenu.classList.remove('show');
                }
            });

            // Close when clicking outside
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target) && e.target !== icon) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        function expandPostDescription(element) {
            const descriptionContainer = element.previousElementSibling;
            const postId = element.closest('.post').getAttribute('data-id');
            const post = posts.find(p => p.id === postId);

            descriptionContainer.classList.remove('collapsed');
            descriptionContainer.innerHTML = post.description.replace(/\n/g, '<br>');
            element.style.display = 'none';
        }

        function likePost(postId) {
            if (!currentUser) {
                alert('Please sign in to like posts');
                return;
            }

            const post = posts.find(p => p.id === postId);
            const isLiked = post.likes?.includes(currentUser.uid);

            db.collection('posts').doc(postId).update({
                    likes: isLiked ?
                        firebase.firestore.FieldValue.arrayRemove(currentUser.uid) : firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                })
                .then(() => {
                    // Send notification if this is a like (not unlike)
                    if (!isLiked && post.userId !== currentUser.uid) {
                        sendNotification(post.userId, 'like', currentUser.uid, postId);
                    }

                    loadPosts();
                    if (viewingProfileUserId) {
                        loadProfilePosts();
                    }
                });
        }

        function deletePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                db.collection('posts').doc(postId).delete()
                    .then(() => {
                        loadPosts();
                        loadProfilePosts();
                    });
            }
        }

        function sharePost(postId) {
            const post = posts.find(p => p.id === postId);

            db.collection('posts').doc(postId).update({
                    shares: firebase.firestore.FieldValue.increment(1)
                })
                .then(() => {
                    loadPosts();
                    if (viewingProfileUserId) {
                        loadProfilePosts();
                    }

                    // In a real app, this would use the Web Share API or similar
                    alert(`Shared post: "${post.title || 'Untitled'}"`);
                });
        }

        function viewUserProfile(userId) {
            if (userId === currentUser?.uid) {
                // Viewing own profile
                viewingProfileUserId = userId;
                showSection('profile');
                followButton.style.display = 'none';
                loadProfilePosts();
            } else {
                // Viewing another user's profile
                viewingProfileUserId = userId;
                showProfileInSection(userId);
            }
        }

        function showProfileInSection(userId) {
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();

                        // Update profile info
                        profileName.textContent = userData.name;
                        profileBio.textContent = userData.bio || "No bio yet";
                        document.getElementById('profileFollowersCount').textContent = userData.followers ? userData.followers.length : 0;
                        document.getElementById('profileFollowingCount').textContent = userData.following ? userData.following.length : 0;
                        profileInitial.textContent = userData.name.charAt(0).toUpperCase();

                        // Update follow button
                        updateFollowButton(userData);

                        // Show profile section
                        showSection('profile');
                        loadProfilePosts();
                    }
                });
        }

        // Find Users functions
        function showFindTab(tab) {
            document.getElementById('findUsersTab').style.display = 'none';
            document.getElementById('followersTab').style.display = 'none';
            document.getElementById('followingTab').style.display = 'none';

            if (tab === 'find') {
                document.getElementById('findUsersTab').style.display = 'block';
                loadSuggestedUsers();
            } else if (tab === 'followers') {
                document.getElementById('followersTab').style.display = 'block';
                loadFollowers();
            } else if (tab === 'following') {
                document.getElementById('followingTab').style.display = 'block';
                loadFollowing();
            }
        }

        function loadFollowers() {
            if (!currentUser || !viewingProfileUserId) return;

            const followersContainer = document.getElementById('followersTab');
            followersContainer.innerHTML = `
                <div class="skeleton skeleton-user"></div>
                <div class="skeleton skeleton-user"></div>
            `;

            db.collection('users').doc(viewingProfileUserId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const followers = userData.followers || [];

                        if (followers.length === 0) {
                            followersContainer.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>No followers yet</h3>
                                </div>
                            `;
                            return;
                        }

                        // Get follower details
                        db.collection('users')
                            .where('__name__', 'in', followers.slice(0, 10)) // Firestore limit of 10 for 'in' queries
                            .get()
                            .then(querySnapshot => {
                                followersContainer.innerHTML = '';

                                querySnapshot.forEach(doc => {
                                    const user = doc.data();
                                    const isFollowing = currentUserData.following && currentUserData.following.includes(doc.id);

                                    const userElement = document.createElement('div');
                                    userElement.className = 'user-item';
                                    userElement.innerHTML = `
                                        <div class="user-item-info" onclick="viewUserProfile('${doc.id}')">
                                            <div class="user-item-avatar">${user.name.charAt(0).toUpperCase()}</div>
                                            <div>
                                                <div class="user-item-name">${user.name}</div>
                                                <div class="user-item-username">@${user.username}</div>
                                            </div>
                                        </div>
                                        ${doc.id !== currentUser.uid ? `
                                        <button class="follow-btn ${isFollowing ? 'following' : ''}" 
                                            onclick="toggleFollowListUser('${doc.id}', this, 'followers')">
                                            ${isFollowing ? 'Following' : 'Follow Back'}
                                        </button>
                                        ` : ''}
                                    `;

                                    followersContainer.appendChild(userElement);
                                });
                            });
                    }
                });
        }

        function loadFollowing() {
            if (!currentUser || !viewingProfileUserId) return;

            const followingContainer = document.getElementById('followingTab');
            followingContainer.innerHTML = `
                <div class="skeleton skeleton-user"></div>
                <div class="skeleton skeleton-user"></div>
            `;

            db.collection('users').doc(viewingProfileUserId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const following = userData.following || [];

                        if (following.length === 0) {
                            followingContainer.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>Not following anyone yet</h3>
                                </div>
                            `;
                            return;
                        }

                        // Get following details
                        db.collection('users')
                            .where('__name__', 'in', following.slice(0, 10)) // Firestore limit of 10 for 'in' queries
                            .get()
                            .then(querySnapshot => {
                                followingContainer.innerHTML = '';

                                querySnapshot.forEach(doc => {
                                    const user = doc.data();
                                    const isFollowing = currentUserData.following && currentUserData.following.includes(doc.id);

                                    const userElement = document.createElement('div');
                                    userElement.className = 'user-item';
                                    userElement.innerHTML = `
                                        <div class="user-item-info" onclick="viewUserProfile('${doc.id}')">
                                            <div class="user-item-avatar">${user.name.charAt(0).toUpperCase()}</div>
                                            <div>
                                                <div class="user-item-name">${user.name}</div>
                                                <div class="user-item-username">@${user.username}</div>
                                            </div>
                                        </div>
                                        ${doc.id !== currentUser.uid ? `
                                        <button class="follow-btn ${isFollowing ? 'following' : ''}" 
                                            onclick="toggleFollowListUser('${doc.id}', this, 'following')">
                                            ${isFollowing ? 'Following' : 'Follow'}
                                        </button>
                                        ` : ''}
                                    `;

                                    followingContainer.appendChild(userElement);
                                });
                            });
                    }
                });
        }

        function toggleFollowListUser(userId, button, listType) {
            const isFollowing = button.textContent === 'Following';

            if (isFollowing) {
                // Unfollow
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayRemove(userId)
                });

                db.collection('users').doc(userId).update({
                    followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                }).then(() => {
                    button.textContent = listType === 'followers' ? 'Follow Back' : 'Follow';
                    button.classList.remove('following');

                    // Update current user data
                    if (currentUserData.following) {
                        currentUserData.following = currentUserData.following.filter(id => id !== userId);
                    }
                });
            } else {
                // Follow
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayUnion(userId)
                });

                db.collection('users').doc(userId).update({
                    followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                }).then(() => {
                    button.textContent = 'Following';
                    button.classList.add('following');

                    // Update current user data
                    if (!currentUserData.following) {
                        currentUserData.following = [];
                    }
                    currentUserData.following.push(userId);

                    // Send notification
                    sendNotification(userId, 'follow', currentUser.uid);
                });
            }
        }

        // Notification functions
        function loadNotifications() {
            if (!currentUser) return;

            const notificationsContainer = document.getElementById('notificationsList');
            notificationsContainer.innerHTML = `
                <div class="skeleton skeleton-user"></div>
                <div class="skeleton skeleton-user"></div>
                <div class="skeleton skeleton-user"></div>
            `;

            db.collection('notifications')
                .doc(currentUser.uid)
                .collection('userNotifications')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .get()
                .then(querySnapshot => {
                    notificationsContainer.innerHTML = '';
                    notificationCount = 0;

                    if (querySnapshot.empty) {
                        notificationsContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-bell"></i>
                                <h3>No notifications yet</h3>
                                <p>Your notifications will appear here</p>
                            </div>
                        `;
                        return;
                    }

                    querySnapshot.forEach(doc => {
                        const notification = doc.data();
                        if (!notification.read) {
                            notificationCount++;
                        }

                        // Get sender info
                        db.collection('users').doc(notification.senderId).get()
                            .then(userDoc => {
                                if (userDoc.exists) {
                                    const user = userDoc.data();
                                    renderNotification(doc.id, notification, user, notificationsContainer);
                                }
                            });
                    });

                    updateNotificationBadge();
                });
        }

        function renderNotification(notificationId, notification, sender, container) {
            const notificationElement = document.createElement('div');
            notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;

            // Format time
            const time = notification.timestamp.toDate();
            const formattedTime = time.toLocaleString('default', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            notificationElement.innerHTML = `
                <div class="notification-header">
                    <span>${formattedTime}</span>
                    ${!notification.read ? '<span class="badge">New</span>' : ''}
                </div>
                <div class="notification-content">
                    <div class="notification-avatar">${sender.name.charAt(0).toUpperCase()}</div>
                    <div class="notification-text">
                        <strong>${sender.name}</strong> ${notification.message}
                    </div>
                </div>
                ${notification.postId ? `
                <div class="notification-actions">
                    <button class="follow-btn" onclick="viewNotificationPost('${notification.postId}')">View Post</button>
                </div>
                ` : ''}
            `;

            notificationElement.onclick = () => markNotificationAsRead(notificationId);
            container.appendChild(notificationElement);
        }

        function markNotificationAsRead(notificationId) {
            if (!currentUser) return;

            db.collection('notifications')
                .doc(currentUser.uid)
                .collection('userNotifications')
                .doc(notificationId)
                .update({
                    read: true
                })
                .then(() => {
                    // Reload notifications
                    loadNotifications();
                });
        }

        function markAllAsRead() {
            if (!currentUser) return;

            // Get all unread notifications
            db.collection('notifications')
                .doc(currentUser.uid)
                .collection('userNotifications')
                .where('read', '==', false)
                .get()
                .then(querySnapshot => {
                    const batch = db.batch();

                    querySnapshot.forEach(doc => {
                        const ref = db.collection('notifications')
                            .doc(currentUser.uid)
                            .collection('userNotifications')
                            .doc(doc.id);
                        batch.update(ref, {
                            read: true
                        });
                    });

                    return batch.commit();
                })
                .then(() => {
                    loadNotifications();
                    hideNotificationSettingsMenu();
                });
        }

        function viewNotificationPost(postId) {
            // In a real app, this would show the post in a modal or scroll to it
            alert(`Would show post ${postId} in a real app`);
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (notificationCount > 0) {
                badge.textContent = notificationCount > 9 ? '9+' : notificationCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function showNotificationSettings() {
            const menu = document.getElementById('notificationSettingsMenu');
            menu.classList.toggle('show');

            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        function hideNotificationSettingsMenu() {
            document.getElementById('notificationSettingsMenu').classList.remove('show');
        }

        function showProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('show');

            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        function editProfile() {
            // Show settings section with profile tab active
            showSection('settings');
            document.getElementById('profileMenu').classList.remove('show');
        }

        function shareProfile(userId = null) {
            const profileId = userId || currentUser.uid;
            // In a real app, this would use the Web Share API or similar
            const dummyInput = document.createElement('input');
            dummyInput.value = `https://connect.social/profile/${profileId}`;
            document.body.appendChild(dummyInput);
            dummyInput.select();
            document.execCommand('copy');
            document.body.removeChild(dummyInput);
            alert('Profile link copied to clipboard!');
        }

        // Settings functions
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');

            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function saveProfileSettings() {
            if (!currentUser) return;

            const name = document.getElementById('settingsName').value;
            const bio = document.getElementById('settingsBio').value;

            const notificationsEnabled = {
                followers: document.getElementById('notifFollowersToggle').checked,
                likes: document.getElementById('notifLikesToggle').checked,
                mentions: document.getElementById('notifMentionsToggle').checked
            };

            db.collection('users').doc(currentUser.uid).update({
                    name,
                    bio,
                    notificationsEnabled
                })
                .then(() => {
                    // Update current user data
                    currentUserData.name = name;
                    currentUserData.bio = bio;
                    currentUserData.notificationsEnabled = notificationsEnabled;

                    // Update profile UI
                    updateProfileUI(currentUserData);
                    alert('Settings saved successfully!');
                })
                .catch(error => {
                    alert('Error saving settings: ' + error.message);
                });
        }

        function showLegalDocument(type) {
            const modal = document.getElementById('legalModal');
            const title = document.getElementById('legalDocTitle');
            const content = document.getElementById('legalDocContent');

            if (type === 'privacy') {
                title.textContent = 'Privacy Policy';
                content.innerHTML = `
                <h2>Privacy Policy</h2>
                <p>This is a placeholder for the privacy policy. In a real application, you would include:</p>
                <ul>
                    <li>What information you collect</li>
                    <li>How you use that information</li>
                    <li>How you protect user data</li>
                    <li>User rights regarding their data</li>
                    <li>Cookies and tracking policies</li>
                    <li>Contact information for privacy concerns</li>
                </ul>
                <p>You should consult with a legal professional to create a proper privacy policy that complies with all applicable laws (GDPR, CCPA, etc.).</p>
            `;
            } else {
                title.textContent = 'Terms of Use';
                content.innerHTML = `
                <h2>Terms of Use</h2>
                <p>This is a placeholder for the terms of use. In a real application, you would include:</p>
                <ul>
                    <li>User responsibilities and acceptable use</li>
                    <li>Content ownership and licensing</li>
                    <li>Disclaimers and limitations of liability</li>
                    <li>Termination conditions</li>
                    <li>Governing law</li>
                    <li>Dispute resolution</li>
                </ul>
                <p>You should consult with a legal professional to create proper terms of use that protect your business and comply with applicable laws.</p>
            `;
            }

            modal.classList.add('show');
        }

        function hideLegalDocument() {
            document.getElementById('legalModal').classList.remove('show');
        }

        function requestAccountDeletion() {
            if (confirm('Are you sure you want to delete your account? This cannot be undone and will remove all your data.')) {
                if (prompt('Type "DELETE" to confirm account deletion:') === 'DELETE') {
                    // In a real app, you would:
                    // 1. Authenticate the user again (password confirmation)
                    // 2. Delete all user data from Firestore/storage
                    // 3. Delete the auth account

                    alert('Account deletion requested. In a real app, this would delete all user data.');
                }
            }
        }

        // Search functions
        function handleSearchInput() {
            const query = document.getElementById('searchQuery').value.trim();
            if (query.length > 2) {
                // In a real app, you might want to debounce this
                searchContent();
            }
        }

        function searchContent() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="skeleton skeleton-user"></div>
                <div class="skeleton skeleton-user"></div>
            `;

            // Search users (name or username)
            db.collection('users')
                .where('username', '>=', query.toLowerCase())
                .where('username', '<=', query.toLowerCase() + '\uf8ff')
                .limit(5)
                .get()
                .then(userSnapshot => {
                    // Search posts (title or content)
                    db.collection('posts')
                        .where('description', '>=', query)
                        .where('description', '<=', query + '\uf8ff')
                        .limit(5)
                        .get()
                        .then(postSnapshot => {
                            resultsContainer.innerHTML = '';

                            if (userSnapshot.empty && postSnapshot.empty) {
                                resultsContainer.innerHTML = `
                                    <div class="empty-state">
                                        <i class="fas fa-search"></i>
                                        <h3>No results found</h3>
                                        <p>Try a different search term</p>
                                    </div>
                                `;
                                return;
                            }

                            // Show users
                            if (!userSnapshot.empty) {
                                const userHeader = document.createElement('h3');
                                userHeader.textContent = 'Users';
                                resultsContainer.appendChild(userHeader);

                                userSnapshot.forEach(doc => {
                                    const user = doc.data();
                                    const isFollowing = currentUserData.following && currentUserData.following.includes(doc.id);

                                    const userElement = document.createElement('div');
                                    userElement.className = 'user-item';
                                    userElement.innerHTML = `
                                        <div class="user-item-info" onclick="viewUserProfile('${doc.id}')">
                                            <div class="user-item-avatar">${user.name.charAt(0).toUpperCase()}</div>
                                            <div>
                                                <div class="user-item-name">${user.name}</div>
                                                <div class="user-item-username">@${user.username}</div>
                                            </div>
                                        </div>
                                        ${doc.id !== currentUser.uid ? `
                                        <button class="follow-btn ${isFollowing ? 'following' : ''}" 
                                            onclick="toggleSearchFollow('${doc.id}', this)">
                                            ${isFollowing ? 'Following' : 'Follow'}
                                        </button>
                                        ` : ''}
                                    `;

                                    resultsContainer.appendChild(userElement);
                                });
                            }

                            // Show posts
                            if (!postSnapshot.empty) {
                                const postHeader = document.createElement('h3');
                                postHeader.textContent = 'Posts';
                                postHeader.style.marginTop = '2rem';
                                resultsContainer.appendChild(postHeader);

                                postSnapshot.forEach(doc => {
                                    const post = doc.data();
                                    post.id = doc.id;
                                    renderPost(post, resultsContainer);
                                });
                            }
                        });
                });
        }

        function toggleSearchFollow(userId, button) {
            const isFollowing = button.textContent === 'Following';

            if (isFollowing) {
                // Unfollow
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayRemove(userId)
                });

                db.collection('users').doc(userId).update({
                    followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                }).then(() => {
                    button.textContent = 'Follow';
                    button.classList.remove('following');

                    // Update current user data
                    if (currentUserData.following) {
                        currentUserData.following = currentUserData.following.filter(id => id !== userId);
                    }
                });
            } else {
                // Follow
                db.collection('users').doc(currentUser.uid).update({
                    following: firebase.firestore.FieldValue.arrayUnion(userId)
                });

                db.collection('users').doc(userId).update({
                    followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                }).then(() => {
                    button.textContent = 'Following';
                    button.classList.add('following');

                    // Update current user data
                    if (!currentUserData.following) {
                        currentUserData.following = [];
                    }
                    currentUserData.following.push(userId);

                    // Send notification
                    sendNotification(userId, 'follow', currentUser.uid);
                });
            }
        }

        // Close sidebar when clicking outside
        document.addEventListener('click', function(e) {
            if (!sidebar.contains(e.target) && !e.target.classList.contains('fa-bars')) {
                sidebar.classList.remove('show');
            }

            // Close post menus when clicking outside
            if (!e.target.classList.contains('post-menu')) {
                document.querySelectorAll('.post-menu-options').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
    </script>
</body>

</html>